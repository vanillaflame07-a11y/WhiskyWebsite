<script>
  let whiskies = [];
  let scores = {};
  let whiskyTypes = {};
  let questions = [];

  const mainView = document.getElementById("mainView");
  const testView = document.getElementById("testView");
  const detailView = document.getElementById("detailView");
  const whiskyList = document.getElementById("whiskyList");
  const searchBox = document.getElementById("searchBox");
  const resultDiv = document.getElementById("result");
  const detailContentDiv = document.getElementById("detailContent");
  const quizForm = document.getElementById("quizForm");

  function renderList(filter = "") {
    whiskyList.innerHTML = "";
    const filteredWhiskies = whiskies.filter(w =>
      w.name.toLowerCase().includes(filter.toLowerCase()) ||
      w.flavor.some(f => f.toLowerCase().includes(filter.toLowerCase()))
    );

    filteredWhiskies.forEach((w) => {
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 cursor-pointer border border-gray-200 transform hover:-translate-y-1";
      card.innerHTML = `
        <img src="${w.image}" alt="${w.name}" class="rounded-lg mb-2 w-full h-auto object-cover">
        <h3 class="text-xl font-bold text-gray-800">${w.name}</h3>
        <p class="text-sm text-gray-500 mt-1">${w.flavor.join(", ")}</p>
      `;
      card.addEventListener("click", () => showDetail(w));
      whiskyList.appendChild(card);
    });
  }

  function startTest() {
    mainView.classList.add("hidden");
    testView.classList.remove("hidden");
  }

  function goBack() {
    mainView.classList.add("hidden");
    testView.classList.add("hidden");
    detailView.classList.add("hidden");
    mainView.classList.remove("hidden");
    resultDiv.innerHTML = '';
    resultDiv.classList.add("hidden");
  }

  function showDetail(whisky) {
    detailContentDiv.innerHTML = `
      <div class="text-center">
        <img src="${whisky.image}" alt="${whisky.name}" class="rounded-lg mb-4 w-48 h-48 sm:w-64 sm:h-64 mx-auto object-cover shadow-md">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">${whisky.name}</h2>
        <p class="text-lg text-gray-600 mb-4">${whisky.flavor.join(", ")}</p>
        <p class="text-gray-700 leading-relaxed">${whisky.description}</p>
      </div>
    `;
    mainView.classList.add("hidden");
    detailView.classList.remove("hidden");
  }

  function calculateResult() {
    const answers = new FormData(quizForm);
    let totals = {};
    let totalScore = 0;
    let allAnswered = true;

    for (let q of questions) {
      const answer = answers.get(q.id);
      if (!answer) {
        allAnswered = false;
        break;
      }
      if (scores[answer]) {
        for (const [type, val] of Object.entries(scores[answer])) {
          totals[type] = (totals[type] || 0) + val;
          totalScore += val;
        }
      }
    }

    let html = `<h3 class="text-2xl font-bold mb-4">🥂 당신의 위스키 취향은...</h3>`;
    if (!allAnswered) {
      html += `<p class="text-lg text-red-500">모든 질문에 답해주세요!</p>`;
      resultDiv.innerHTML = html;
      resultDiv.classList.remove("hidden");
      return;
    }

    const sorted = Object.entries(totals).sort((a, b) => b[1] - a[1]);
    sorted.forEach(([type, val], idx) => {
      const percent = ((val / totalScore) * 100).toFixed(1);
      html += `<p class="mb-2 text-lg"><strong class="font-semibold">${idx + 1}.</strong> ${whiskyTypes[type]}<br> <span class="text-sm text-gray-500">점수: ${val}점 (${percent}%)</span></p>`;
    });

    resultDiv.innerHTML = html;
    resultDiv.classList.remove("hidden");
  }

  async function fetchWhiskies() {
    try {
      const response = await fetch('/api/whiskies');
      const data = await response.json();
      whiskies = data;
      renderList();
    } catch (error) {
      console.error('위스키 데이터를 가져오는 데 실패했습니다:', error);
      whiskyList.innerHTML = '<p class="text-red-500">데이터를 불러오는 데 실패했습니다.</p>';
    }
  }

  async function fetchTestData() {
    try {
      const [qRes, sRes, tRes] = await Promise.all([
        fetch("/api/questions"),
        fetch("/api/scores"),
        fetch("/api/whisky_types")
      ]);
      questions = await qRes.json();
      scores = await sRes.json();
      whiskyTypes = await tRes.json();
      renderQuestions();
    } catch (err) {
      console.error("테스트 데이터 불러오기 실패:", err);
    }
  }

  function renderQuestions() {
    quizForm.innerHTML = "";
    questions.forEach(q => {
      const div = document.createElement("div");
      div.className = "question bg-gray-50 p-4 rounded-lg mb-4";
      div.innerHTML = `<p class="text-lg font-semibold text-gray-700 mb-2">${q.text}</p>`;
      q.options.forEach(opt => {
        div.innerHTML += `
          <label class="block cursor-pointer py-2 px-4 rounded-md mb-2 bg-white border border-gray-200 hover:bg-gray-100 transition-colors">
            <input type="radio" name="${q.id}" value="${opt.value}" class="mr-2"> ${opt.label}
          </label>`;
      });
      quizForm.appendChild(div);
    });
    quizForm.innerHTML += `
      <button type="button" onclick="calculateResult()" class="w-full bg-amber-500 text-white font-bold py-3 rounded-full hover:bg-amber-600 transition-colors shadow-md transform hover:scale-105 duration-200">
        결과 보기
      </button>`;
  }

  searchBox.addEventListener("input", (e) => renderList(e.target.value));
  fetchWhiskies();
  fetchTestData();
</script>
